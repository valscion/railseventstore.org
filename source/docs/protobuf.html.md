# Using Rails Event Store with Protobuf

Using RES with Protobuf or another binary serialization protocol might be a good idea if you want to share your events' data with another applications and micro-services.

## Installation

Add RES and protobuf to your app's `Gemfile`

```ruby
gem 'google-protobuf'
gem 'rails_event_store'
```

## Configure protobuf mapper

```ruby
Rails.application.configure do
  config.to_prepare do
    Rails.configuration.event_store = RailsEventStore::Client.new(
      repository: RailsEventStoreActiveRecord::EventRepository.new(
        mapper: RubyEventStore::Mappers::Protobuf.new
      )
    )
  end
end
```

## Defining events

Define your events in protobuf file format i.e.: `events.proto3`

```
syntax = "proto3";
package my_app;

message OrderPlaced {
  string event_id = 1;
  string order_id = 2;
  int32 customer_id = 3;
}
```

and generate the Ruby classes:

```ruby
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: events.proto3

require 'google/protobuf'

Google::Protobuf::DescriptorPool.generated_pool.build do
  add_message "my_app.OrderPlaced" do
    optional :event_id, :string, 1
    optional :order_id, :string, 2
    optional :customer_id, :int32, 3
  end
end

module MyApp
  OrderPlaced = Google::Protobuf::DescriptorPool.generated_pool.lookup("res_testing.OrderCreated").msgclass
end

```

### Metadata

Rails Event Store can automatically fill out some meta-data for your events such as:

* `timestamp`
* `remote_ip`
* `request_id`

If you want to include them, define those fields in your event schema definition as well.

```
syntax = "proto3";
package my_app;

message OrderPlaced {
  string event_id = 1;
  string order_id = 2;
  int32 customer_id = 3;
  
  string rempote_ip = 4;
}
```

## Publishing

```ruby
event_store = Rails.configuration.event_store

event = MyApp::OrderPlaced.new(
  event_id: "f90b8848-e478-47fe-9b4a-9f2a1d53622b",
  customer_id: 123,
  order_id: "K3THNX9",
)
event_store.publish_event(event, stream_name: "Order-K3THNX9")
```

## Retrieving

```ruby
event = client.read_stream_events_forward('test').last
```

## Async handlers

* BUG: [Protobuf cannot be used with async handlers](https://github.com/RailsEventStore/rails_event_store/issues/228)